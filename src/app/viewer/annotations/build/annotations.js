var userInControl=!0;!function(){if("function"==typeof window.Event)return;function t(t,e){var n=document.createEvent("Event");return n.initEvent(t,!0,!1),n}t.prototype=window.Event.prototype,window.Event=t}();var Annotation=function(){"use strict";return function(t,e){return new Annotation.AnnoBoard(t,e)}}();!function(o){"use strict";var t=!!window.hasOwnProperty("ontouchstart"),e={DOWN:t?"touchstart":"mousedown",MOVE:t?"touchmove":"mousemove",UP:t?"touchend":"mouseup",LEAVE:t?"touchleave":"mouseleave"};o.actions=function(t){this.baseElement=t,this.isActionStarted=!1,this.isActionCompleted=!1,this.implementedAction=null},o.actions.prototype.attachActions=function(){var i=this;function n(t,e){var n=i.baseElement.getClientRects()[0];return{x:t-n.left,y:e-n.top}}this.mousedownListener=function(t){i.isActionStarted=!0,i.isActionCompleted=!1,i.baseElement.width=parseFloat(i.baseElement.getClientRects()[0].width),i.baseElement.height=parseFloat(i.baseElement.getClientRects()[0].height)},this.mousemoveListener=function(t){i.isActionStarted&&!i.isActionCompleted&&(t.x&&t.y||(t.x=t.touches[0].clientX,t.y=t.touches[0].clientY),i.implementedAction.actionChangeBehavior(i.baseElement,n(t.x,t.y)))},this.mouseupListener=function(t){if(i.isActionStarted=!1,i.isActionCompleted=!0,t.x&&t.y||(t.x=t.touches[0].clientX,t.y=t.touches[0].clientY),i.implementedAction.actionCompleteBehavior(i.baseElement,n(t.x,t.y)),i.implementedAction.marker){if(i.implementedAction&&i.implementedAction.onSave){i.implementedAction.onSave("");var e="function"==typeof Event?new Event("onAnnotationSave"):window.Event;e.annotation=i.implementedAction,i.baseElement.parentNode.dispatchEvent(e)}i.baseElement.style.display="none"}else{o.Editor("onDrawn",{x:t.x,y:t.y},i.implementedAction,i.baseElement.parentNode).then(function(){i.baseElement.style.display="none"},function(){i.baseElement.style.display="none"}).catch(function(){i.baseElement.style.display="none"})}},this.mouseleaveListener=function(t){i.isActionStarted=!1,i.isActionCompleted=!0},this.baseElement.addEventListener(e.DOWN,this.mousedownListener),this.baseElement.addEventListener(e.MOVE,this.mousemoveListener),this.baseElement.addEventListener(e.UP,this.mouseupListener),this.baseElement.addEventListener(e.LEAVE,this.mouseleaveListener)},o.actions.prototype.detachActions=function(){this.baseElement.removeEventListener(e.DOWN,this.mousedownListener),this.baseElement.removeEventListener(e.MOVE,this.mousemoveListener),this.baseElement.removeEventListener(e.UP,this.mouseupListener),this.baseElement.removeEventListener(e.LEAVE,this.mouseleaveListener)},o.actions.prototype.setBehavior=function(t){this.implementedAction=t}}(Annotation),function(p){"use strict";var m=document.createElement("div"),y="function"==typeof Event?new Event("onAnnotationSave"):window.Event,u="function"==typeof Event?new Event("onAnnotationDelete"):window.Event,f="function"==typeof Event?new Event("onAnnotationEdit"):window.Event,v="function"==typeof Event?new Event("onAnnotationCancel"):window.Event,g=!1,x=!1;p.Editor=function(s,a,r,l){if(!g||"edit"===s){var h=r.marker;m.innerHTML="<form><div class='top-left annotation-popup' id='annotation-popup'><div id='annotation-comments'></div><div class='annotation-popup-buttons' id='annotation-popup-buttons'><a class='annotation-popup-button annotation-popup-button-edit' id='annotation-popup-button-fill' title='Fill' href='javascript:void(0);'>Fill</a><a class='annotation-popup-button annotation-popup-button-edit' id='annotation-popup-button-edit' title='Edit' href='javascript:void(0);'>EDIT</a><a class='annotation-popup-button annotation-popup-button-delete' id='annotation-popup-button-delete' title='Delete' href='javascript:void(0);'>DELETE</a></div><span class='annotation-popup-text'></span><div id='popup-user-details' class='user-details'></div></div><div id='annotation-editor' class='annotation-editor-field'><form><textarea id='annotation-editor-text' class='annotation-editor-text' placeholder='Add a Comment...' tabindex='1'></textarea><span class='error-message' id='error-message'></span><div id='editor-user-details' class='user-details'></div><div class='annotation-editor-button-container'><a class='annotation-editor-button annotation-editor-button-cancel' id='annotation-editor-button-cancel' href='javascript:void(0);' tabindex='3'>Cancel</a><a class='annotation-editor-button annotation-editor-button-save disabled' id='annotation-editor-button-save' href='javascript:void(0);' tabindex='2'>Save</a></div></form></div></form>",m.style.position="absolute",m.style.zIndex="999999998",m.style.display="block",document.body.appendChild(m);var d=!0,c=!1;return m.firstChild.style.position="fixed",m.firstChild.style.top=(a.y>window.innerHeight-90?window.innerHeight-90:a.y)+"px",m.firstChild.style.left=(a.x>window.innerWidth-300?window.innerWidth-300:a.x)+"px",new Promise(function(e,t){if("highlight"===s){x=!0,document.getElementById("annotation-comments").innerHTML=r.comment.replace(",","<br/>"),document.getElementById("popup-user-details").innerHTML=r.user,m.style.width="auto",m.style.height="auto";var n=document.getElementById("annotation-popup").style;n.display="block",document.getElementById("annotation-editor").style.display="none",n.backgroundColor="rgba(100,100,100,0.8)",n.padding="10px",userInControl&&"system.analysis@airamatrix.com"!=r.user||(document.getElementById("annotation-popup-buttons").style.display="none"),m.firstElementChild.addEventListener("mouseleave",function(t){d=!0}),r.element.addEventListener("mouseleave",function(t){c=!0}),m.firstElementChild.addEventListener("mouseover",function(t){d=!1}),r.element.addEventListener("mouseover",function(t){c=!1});setInterval(function(){d&&c&&(p.hideEditor(),d=c=!1)},20);m.style.top="0";var i=!(m.style.left="0");h?(document.getElementById("annotation-popup-button-fill").style.display="inline-block",document.getElementById("annotation-popup-button-edit").style.display="none",document.getElementById("annotation-popup-button-fill").addEventListener("click",function(t){r&&r.fillColor&&r.fillColor("blue"),m.style.display="none"})):(document.getElementById("annotation-popup-button-fill").style.display="none",document.getElementById("annotation-popup-button-edit").style.display="inline-block",document.getElementById("annotation-popup-button-edit").addEventListener("click",function(){r&&r.onEdit&&r.onEdit(),m.style.display="none",g=!0,p.Editor("edit",a,r,l)})),document.getElementById("annotation-popup-button-delete").addEventListener("click",function(){r&&r.deleteAnnotation&&(r.deleteAnnotation(),u.annotation=r,l.dispatchEvent(u)),m.style.display="none"})}else{m.style.width=document.documentElement.scrollWidth+"px",m.style.height=document.documentElement.scrollHeight+"px",m.style.top="0",m.style.left="0",m.style.backgroundColor="rgba(0, 0, 0, 0.3)",document.getElementById("annotation-editor").style.display="block",document.getElementById("annotation-popup").style.display="none",r.comment&&(document.getElementById("annotation-editor-text").value=r.comment,document.getElementById("editor-user-details").innerHTML=r.user);var o=function(){var t=document.getElementById("annotation-editor-text").value,e=document.getElementById("error-message"),n=document.getElementById("annotation-editor-button-save");t?(i=!0,e.innerHTML="",n.classList.remove("disabled")):(i=!1,e.innerHTML="Please enter some comment",n.classList.add("disabled"))};document.getElementById("annotation-editor-text").addEventListener("keyup",o),document.getElementById("annotation-editor-button-save").addEventListener("click",function(){if(o(),!i)return!1;!function(){if(r&&r.onSave){var t=document.getElementById("annotation-editor-text").value;r.onSave(t),g?(f.annotation=r,l.dispatchEvent(f)):(y||(y=window.Event),y.annotation=r,l.dispatchEvent(y))}m.style.display="none",g=!1,e("saved")}()}),document.getElementById("annotation-editor-button-cancel").addEventListener("click",function(){return r&&r.deleteAnnotation&&!g&&r.deleteAnnotation(),v.annotation=r,l.dispatchEvent(v),m.style.display="none",g=!1,t("cancelled")})}})}},p.hideEditor=function(){x&&(document.getElementById("annotation-popup").style.display="none",x=!1)}}(Annotation),function(m){"use strict";var i=!0;function o(t,e){t.x<e.x?(e.width+=e.x-t.x,e.x=t.x):t.x>e.x+e.width&&(e.width=t.x-e.x),t.y<e.y?(e.height+=e.y-t.y,e.y=t.y):t.y>e.y+e.height&&(e.height=t.y-e.y)}function y(t){var e,n={x:t[0].x,y:t[0].y,width:0,height:0},i=t[0].x,o=t[0].y;for(e=1;e<t.length;e+=1){var s=t[e];s.x<n.x?n.x=s.x:s.x>i&&(i=s.x),n.width=i-n.x,s.y<n.y?n.y=s.y:s.y>o&&(o=s.y),n.height=o-n.y}return n}function u(t,e){return(e.y-t.y)/(e.x-t.x)}m.freeformAction=function(t,e){if(this.type="OpenFreeform",this.color="#00ff00",this.lineWidth=5,this.points=[],this.comment="",Object.hasOwnProperty("assign"))Object.assign(this,t);else for(var n in t)this[n]=t[n];this.actionBoundaries=e||(this.points&&0<this.points.length?y(this.points):{x:0,y:0,width:0,height:0}),this.element=null},m.freeformAction.prototype.actionChangeBehavior=function(t,e){var n=t.getContext("2d");n.strokeStyle=this.color,n.lineWidth=this.lineWidth,i?(this.actionBoundaries.x=e.x,this.actionBoundaries.y=e.y,n.beginPath(),n.moveTo(e.x,e.y),this.points.push(e),i=!1):(n.lineTo(e.x,e.y),n.stroke(),this.points.push(e),o(e,this.actionBoundaries))},m.freeformAction.prototype.actionCompleteBehavior=function(t,e){var n=t.getContext("2d");n.lineTo(e.x,e.y),n.stroke(),n.closePath(),this.points.push(e),o(e,this.actionBoundaries),this.showAnnotation(this.points,t.parentNode),i=!0},m.freeformAction.prototype.showAnnotation=function(t,e){var n,i,o,s=document.createElement("div"),a=t[0];for(t=function(t,e){e=e||1;for(var n=[t[0],t[1]],i=t[0],o=u(t[1],i),s=t.length,a=2;a<s;a++){var r=t[a];if(!(Math.abs(r.x-i.x)<3&&Math.abs(r.y-i.y)<3)){var l=u(r,i);Math.abs(l-o)<e&&n.pop(),n.push(r),i=r,o=l}}return n}(t,.15),s.setAttribute("id","freeform-annotation"),this.actionBoundaries&&0!==this.actionBoundaries.width||(this.actionBoundaries=y(t)),s.style.width=this.actionBoundaries.width+"px",s.style.height=this.actionBoundaries.height+"px",s.style.zIndex="2",this.size=this.actionBoundaries.width*this.actionBoundaries.height,n=1;n<t.length;n+=1){var r=t[n],l=document.createElement("hr"),h=r.x-a.x,d=r.y-a.y,c=Math.sqrt(h*h+d*d),p=180*Math.atan2(r.y-a.y,r.x-a.x)/Math.PI;l.style.borderColor="#00ff00",l.style.borderWidth=this.lineWidth+"px",l.style.width=100*c/this.actionBoundaries.width+"%",l.style.height="0px",l.style.position="absolute",l.style.top=100*(a.y-this.actionBoundaries.y)/this.actionBoundaries.height+"%",l.style.left=100*(a.x-this.actionBoundaries.x)/this.actionBoundaries.width+"%",l.style.margin="0px",l.style.transformOrigin="left center",l.setAttribute("noshade",""),l.style.transform="rotate("+p+"deg)",s.appendChild(l),a=t[n]}this.element=s,this.element.style.position="absolute",this.element.style.top=this.actionBoundaries.y+"px",this.element.style.left=this.actionBoundaries.x+"px",e.appendChild(this.element),i=this,o=e.firstElementChild,i.element.addEventListener("mouseenter",function(t){var e=i.getHighlightPosition();m.Editor("highlight",e,i,o.parentNode)})},m.freeformAction.prototype.deleteAnnotation=function(){this.element.parentNode.removeChild(this.element)},m.freeformAction.prototype.onSave=function(t){this.comment=t},m.freeformAction.prototype.onCancel=function(){this.deleteAnnotation()},m.freeformAction.prototype.getHighlightPosition=function(){var t=this.element.getClientRects()[0],e=this.element.parentElement.getClientRects()[0];return{x:Math.max(t.left,e.left,0),y:Math.max(t.top,e.top,0)}}}(Annotation),function(y){"use strict";var o=!0;function s(t,e){t.x<e.x?(e.width+=e.x-t.x,e.x=t.x):t.x>e.x+e.width&&(e.width=t.x-e.x),t.y<e.y?(e.height+=e.y-t.y,e.y=t.y):t.y>e.y+e.height&&(e.height=t.y-e.y)}function u(t){var e,n={x:t[0].x,y:t[0].y,width:0,height:0},i=t[0].x,o=t[0].y;for(e=1;e<t.length;e+=1){var s=t[e];s.x<n.x?n.x=s.x:s.x>i&&(i=s.x),n.width=i-n.x,s.y<n.y?n.y=s.y:s.y>o&&(o=s.y),n.height=o-n.y}return n}function f(t,e){return(e.y-t.y)/(e.x-t.x)}y.closedFreeformAction=function(t,e){if(this.type="Freeform",this.color="#00ff00",this.lineWidth=5,this.points=[],this.comment="",Object.hasOwnProperty("assign"))Object.assign(this,t);else for(var n in t)this[n]=t[n];this.actionBoundaries=e||(this.points&&0<this.points.length?u(this.points):{x:0,y:0,width:0,height:0}),this.element=null,this.fillElement=null,this.tempLayer=null},y.closedFreeformAction.prototype.actionChangeBehavior=function(t,e){var n=t.getContext("2d"),i=this.tempLayer?this.tempLayer.getContext("2d"):null;this.marker&&(this.color="#000"),n.strokeStyle=this.color,n.lineWidth=this.lineWidth,i&&(i.strokeStyle=this.color,i.lineWidth=n.lineWidth),o?(this.tempLayer=t.cloneNode(!0),this.tempLayer.style.zIndex="2",this.tempLayer.style.position="absolute",t.parentNode.appendChild(this.tempLayer),this.actionBoundaries.x=e.x,this.actionBoundaries.y=e.y,n.beginPath(),n.moveTo(e.x,e.y),this.points.push(e),o=!1):(n.lineTo(e.x,e.y),n.stroke(),this.points.push(e),s(e,this.actionBoundaries),i.clearRect(0,0,n.canvas.width,n.canvas.height),i.beginPath(),i.moveTo(this.points[0].x,this.points[0].y),i.lineTo(e.x,e.y),i.stroke())},y.closedFreeformAction.prototype.actionCompleteBehavior=function(t,e){var n=t.getContext("2d");n.lineTo(e.x,e.y),n.lineTo(this.points[0].x,this.points[0].y),n.stroke(),n.closePath(),this.points.push(e),this.points.push(this.points[0]),s(e,this.actionBoundaries),this.tempLayer.parentNode.removeChild(this.tempLayer),this.showAnnotation(this.points,t.parentNode),o=!0},y.closedFreeformAction.prototype.showAnnotation=function(t,e){var n,i,o,s,a=document.createElement("div"),r=t[0];for(a.setAttribute("id","closed-freeform-annotation"),t=this.points=function(t,e){e=e||1;for(var n=[t[0],t[1]],i=t[0],o=f(t[1],i),s=t.length,a=2;a<s;a++){var r=t[a];if(!(Math.abs(r.x-i.x)<3&&Math.abs(r.y-i.y)<3)){var l=f(r,i);Math.abs(l-o)<e&&n.pop(),n.push(r),i=r,o=l}}return n}(t,.15),this.actionBoundaries&&0!==this.actionBoundaries.width||(this.actionBoundaries=u(t)),a.style.width=this.actionBoundaries.width+"px",a.style.height=this.actionBoundaries.height+"px",a.style.zIndex="2",this.size=this.actionBoundaries.width*this.actionBoundaries.height,n=1;n<t.length;n+=1){var l=t[n],h=document.createElement("hr"),d=l.x-r.x,c=l.y-r.y,p=Math.sqrt(d*d+c*c),m=180*Math.atan2(l.y-r.y,l.x-r.x)/Math.PI;h.style.borderColor=this.color,h.style.borderWidth=this.lineWidth+"px",h.style.width=100*p/this.actionBoundaries.width+"%",h.style.height="0px",h.style.position="absolute",h.style.top=100*(r.y-this.actionBoundaries.y)/this.actionBoundaries.height+"%",h.style.left=100*(r.x-this.actionBoundaries.x)/this.actionBoundaries.width+"%",h.style.margin="0px",h.style.transformOrigin="left center",h.setAttribute("noshade",""),h.style.transform="rotate("+m+"deg)",a.appendChild(h),r=t[n]}this.element=a,this.element.style.position="absolute",this.element.style.top=this.actionBoundaries.y+"px",this.element.style.left=this.actionBoundaries.x+"px",e.appendChild(this.element),this.marker?(i=this,e.firstElementChild,i.element.addEventListener("click",function(t){i.fillColor(getFillColor())})):(o=this,s=e.firstElementChild,o.element.addEventListener("mouseenter",function(t){var e=o.getHighlightPosition();y.Editor("highlight",e,o,s.parentNode)}))},y.closedFreeformAction.prototype.fillColor=function(t){if(this.fillColor=t,this.fillElement){(e=this.fillElement.getContext("2d")).fillStyle=t,e.globalAlpha=.5,e.fill}else{var e,n=document.createElement("canvas");n.width=this.actionBoundaries.width,n.height=this.actionBoundaries.height,n.style.width=this.actionBoundaries.width+"px",n.style.height=this.actionBoundaries.height+"px",(e=n.getContext("2d")).beginPath();var i,o=this.points,s=this.actionBoundaries.x,a=this.actionBoundaries.y;for(e.moveTo(o[0].x-s,o[0].y-a),i=1;i<o.length;i+=1){var r=o[i];e.lineTo(r.x-s,r.y-a)}e.lineTo(o[0].x-s,o[0].y-a),e.stroke(),e.closePath(),e.globalAlpha=.5,e.fillStyle=t,e.fill(),this.element.appendChild(n),n.style.width="100%",n.style.height="100%",this.fillElement=n}},y.closedFreeformAction.prototype.deleteAnnotation=function(){this.element.parentNode.removeChild(this.element)},y.closedFreeformAction.prototype.onSave=function(t){this.comment=t},y.closedFreeformAction.prototype.onCancel=function(){this.deleteAnnotation()},y.closedFreeformAction.prototype.getHighlightPosition=function(){var t=this.element.getClientRects()[0],e=this.element.parentElement.getClientRects()[0];return{x:Math.max(t.left,e.left,0),y:Math.max(t.top,e.top,0)}}}(Annotation),function(o){"use strict";var i=!0;o.rectangularAction=function(t){if(this.type="Rectangular",this.color="#00ff00",Object.hasOwnProperty("assign"))Object.assign(this,t);else for(var e in t)this[e]=t[e];this.element=null},o.rectangularAction.prototype.actionChangeBehavior=function(t,e){var n=t.getContext("2d");n.strokeStyle=this.color,n.lineWidth="5",i?(n.beginPath(),this.x=e.x,this.y=e.y,this.width=1,this.height=1,i=!1):(this.width=e.x-this.x,this.height=e.y-this.y,n.clearRect(0,0,n.canvas.width,n.canvas.height),n.beginPath(),n.rect(this.x,this.y,this.width,this.height),n.stroke())},o.rectangularAction.prototype.actionCompleteBehavior=function(t,e){t.getContext("2d").closePath(),this.showAnnotation(t.parentNode),this.points=[],i=!0},o.rectangularAction.prototype.showAnnotation=function(t){var n,i,e=document.createElement("div");e.setAttribute("id","rectangular-annotation"),e.style.width=Math.abs(this.width)+"px",e.style.height=Math.abs(this.height)+"px",e.style.zIndex="2",e.style.border="5px solid "+this.color,this.size=Math.abs(this.width)*Math.abs(this.height),this.element=e,this.element.style.position="absolute",this.element.style.top=0<this.height?this.y+"px":this.y+this.height+"px",this.element.style.left=0<this.width?this.x+"px":this.x+this.width+"px",t.appendChild(this.element),n=this,i=t.firstElementChild,n.element.addEventListener("mouseenter",function(t){var e=n.getHighlightPosition();o.Editor("highlight",e,n,i.parentNode)})},o.rectangularAction.prototype.deleteAnnotation=function(){this.element.parentNode.removeChild(this.element)},o.rectangularAction.prototype.onSave=function(t){this.comment=t},o.rectangularAction.prototype.getHighlightPosition=function(){var t=this.element.getClientRects()[0],e=this.element.parentElement.getClientRects()[0];return{x:Math.max(t.left,e.left,0),y:Math.max(t.top,e.top,0)}}}(Annotation),function(o){"use strict";var s=!0;o.circularAction=function(t){if(this.type="Circular",this.color="#00ff00",Object.hasOwnProperty("assign"))Object.assign(this,t);else for(var e in t)this[e]=t[e];this.element=null},o.circularAction.prototype.actionChangeBehavior=function(t,e){var n,i,o=t.getContext("2d");o.strokeStyle=this.color,o.lineWidth="5",s?(o.beginPath(),this.centerX=e.x,this.centerY=e.y,this.radius=1,s=!1):(this.radius=(n=e,i={x:this.centerX,y:this.centerY},Math.sqrt((i.x-n.x)*(i.x-n.x)+(i.y-n.y)*(i.y-n.y))),o.clearRect(0,0,o.canvas.width,o.canvas.height),o.beginPath(),o.arc(this.centerX,this.centerY,this.radius,0,2*Math.PI),o.stroke())},o.circularAction.prototype.actionCompleteBehavior=function(t,e){t.getContext("2d").closePath(),this.showAnnotation(t.parentNode),s=!0},o.circularAction.prototype.showAnnotation=function(t){var n,i,e=document.createElement("div");e.setAttribute("id","circular-annotation"),e.style.width=2*this.radius+"px",e.style.height=2*this.radius+"px",e.style.zIndex="2",e.style.border="5px solid "+this.color,e.style.borderRadius="50%",this.size=4*this.radius,this.element=e,this.points=[],this.element.style.position="absolute",this.element.style.top=this.centerY-this.radius+"px",this.element.style.left=this.centerX-this.radius+"px",t.appendChild(this.element),n=this,i=t.firstElementChild,n.element.addEventListener("mouseenter",function(t){var e=n.getHighlightPosition();o.Editor("highlight",e,n,i.parentNode)})},o.circularAction.prototype.deleteAnnotation=function(){this.element.parentNode.removeChild(this.element)},o.circularAction.prototype.onSave=function(t){this.comment=t},o.circularAction.prototype.getHighlightPosition=function(){var t=this.element.getClientRects()[0],e=this.element.parentElement.getClientRects()[0];return{x:Math.max(t.left,e.left,0),y:Math.max(t.top,e.top,0)}}}(Annotation),function(h){"use strict";var a=!0;h.rulerAction=function(t){if(this.type="Ruler",this.color="#00ff00",Object.hasOwnProperty("assign"))Object.assign(this,t);else for(var e in t)this[e]=t[e];this.element=null},h.rulerAction.prototype.actionChangeBehavior=function(t,e){var n=t.getContext("2d");if(n.strokeStyle=this.color,n.font="15px Arial green",n.lineWidth="5",a)n.beginPath(),this.x1=e.x,this.y1=e.y,this.x2=e.x+1,this.y2=e.y+1,a=!1;else{if(this.x2=e.x,this.y2=e.y,n.clearRect(0,0,n.canvas.width,n.canvas.height),n.beginPath(),n.moveTo(this.x1,this.y1),n.lineTo(this.x2,this.y2),0<this.pixelToNanometer){var i=this.getRealDistance(),o=(this.x2+this.x1)/2,s=(this.y2+this.y1)/2-30;n.fillStyle=this.color,n.fillText(i,o,s),this.realDistance=i}n.stroke()}},h.rulerAction.prototype.actionCompleteBehavior=function(t,e){var n=t.getContext("2d");this.x2=e.x,this.y2=e.y,n.clearRect(0,0,n.canvas.width,n.canvas.height),n.beginPath(),n.moveTo(this.x1,this.y1),n.lineTo(this.x2,this.y2),n.stroke(),n.closePath(),this.showAnnotation(t.parentNode),this.points=[],a=!0},h.rulerAction.prototype.showAnnotation=function(t){var e=document.createElement("div");e.setAttribute("id","ruler-annotation");var n=Math.abs(this.x2-this.x1),i=Math.abs(this.y2-this.y1),o=Math.sqrt(n*n+i*i);this.length=o,e.style.width=o+"px",e.style.height=i+"px";var s=document.createElement("hr");s.style.borderColor="#00ff00",s.style.borderWidth="5px",s.style.width="100%",s.style.position="absolute",s.style.margin="0px",s.setAttribute("noshade","");var a,r,l=180*Math.atan((this.y2-this.y1)/(this.x2-this.x1))/Math.PI;(this.x2<this.x1&&this.y2>this.y1||this.x2<this.x1&&this.y2<this.y1)&&(l=180+l),this.angle=l,s.style.transform="rotate("+l+"deg)",s.style.transformOrigin="left top",this.size=Math.abs(n)*Math.abs(i),e.appendChild(s),this.element=e,this.element.style.position="absolute",this.element.style.top=this.y1+"px",this.element.style.left=this.x1+"px",t.appendChild(this.element),this.addMeasurementLabel(),a=this,r=t.firstElementChild,a.element.addEventListener("mouseenter",function(t){var e=a.getHighlightPosition();h.Editor("highlight",e,a,r.parentNode)})},h.rulerAction.prototype.getRealDistance=function(){var t=this.x2-this.x1,e=this.y2-this.y1,n=Math.sqrt(t*t+e*e)*this.pixelToNanometer;return n<Math.pow(10,3)?n=n.toFixed(2)+" nm":n<Math.pow(10,6)?n=(n/1e3).toFixed(2)+" &mu;m":n<Math.pow(10,9)&&(n=(n/Math.pow(10,6)).toFixed(2)+" mm"),n},h.rulerAction.prototype.addMeasurementLabel=function(){var t=document.createElement("div"),e=(this.angle,1);t.style.position="absolute",this.x2<this.x1&&this.angle-180,this.y2<this.y1&&(e=-1),t.innerHTML=this.realDistance?this.realDistance:this.getRealDistance(),t.style.left=(this.x2-this.x1)/2/this.length*100+"%",t.style.top=50*e+"%",t.style.fontSize="18px",t.style.fontWeight="bold",t.style.zIndex="99",t.style.color="#00ff00",t.style.padding="2px",this.element.appendChild(t)},h.rulerAction.prototype.setConverter=function(t){this.pixelToNanometer=t},h.rulerAction.prototype.deleteAnnotation=function(){this.element.parentNode.removeChild(this.element)},h.rulerAction.prototype.onSave=function(t){this.comment=t},h.rulerAction.prototype.getHighlightPosition=function(){var t=this.element.getClientRects()[0],e=this.element.parentElement.getClientRects()[0];return{x:Math.max(t.left,e.left,0),y:Math.max(t.top,e.top,0)}}}(Annotation),function(p){"use strict";var h=!0;p.arrowAction=function(t){if(this.type="Arrow",this.color="#00ff00",Object.hasOwnProperty("assign"))Object.assign(this,t);else for(var e in t)this[e]=t[e];this.element=null},p.arrowAction.prototype.actionChangeBehavior=function(t,e){var n=t.getContext("2d");if(n.strokeStyle=this.color,n.lineWidth="5",h)n.beginPath(),this.x1=e.x,this.y1=e.y,this.x2=e.x+1,this.y2=e.y+1,h=!1;else{this.x2=e.x,this.y2=e.y,n.clearRect(0,0,n.canvas.width,n.canvas.height),n.beginPath(),n.moveTo(this.x1,this.y1),n.lineTo(this.x2,this.y2);var i=Math.atan2(this.y2-this.y1,this.x2-this.x1),o=45*Math.PI/180,s=this.x2-20*Math.cos(i-o),a=this.y2-20*Math.sin(i-o),r=this.x2-20*Math.cos(i+o),l=this.y2-20*Math.sin(i+o);n.lineTo(s,a),n.lineTo(this.x2,this.y2),n.lineTo(r,l),n.stroke()}},p.arrowAction.prototype.actionCompleteBehavior=function(t,e){t.getContext("2d").closePath(),this.showAnnotation(t.parentNode),this.points=[],h=!0},p.arrowAction.prototype.showAnnotation=function(t){var e=document.createElement("div");e.setAttribute("id","arrow-annotation");var n=Math.abs(this.x2-this.x1),i=Math.abs(this.y2-this.y1),o=Math.sqrt(n*n+i*i);this.length=o,e.style.width=o+"px",e.style.height=i+"px";var s=document.createElement("div"),a=document.createElement("hr");a.style.borderColor="#00ff00",a.style.borderWidth="4px",a.style.width="100%",a.style.position="absolute",a.style.margin="0px",a.setAttribute("noshade","");var r=180*Math.atan((this.y2-this.y1)/(this.x2-this.x1))/Math.PI;(this.x2<this.x1&&this.y2>this.y1||this.x2<this.x1&&this.y2<this.y1)&&(r=180+r),this.angle=r,s.appendChild(a),s.style.transform="rotate("+r+"deg)",s.style.transformOrigin="left top",this.size=Math.abs(n)*Math.abs(i),e.appendChild(s);var l,h,d=document.createElement("i"),c=d.style;c.border="solid #00ff00",c.borderWidth="0 4px 4px 0",c.width="20px",c.height="20px",c.display="inline-block",c.padding="3px",c.marginTop="-9px",c.float="right",c.transform="rotate(-45deg)",s.appendChild(d),this.element=e,this.element.style.position="absolute",this.element.style.top=this.y1+"px",this.element.style.left=this.x1+"px",t.appendChild(this.element),l=this,h=t.firstElementChild,l.element.addEventListener("mouseenter",function(t){var e=l.getHighlightPosition();p.Editor("highlight",e,l,h.parentNode)})},p.arrowAction.prototype.deleteAnnotation=function(){this.element.parentNode.removeChild(this.element)},p.arrowAction.prototype.onSave=function(t){this.comment=t},p.arrowAction.prototype.getHighlightPosition=function(){var t=this.element.getClientRects()[0],e=this.element.parentElement.getClientRects()[0];return{x:Math.max(t.left,e.left,0),y:Math.max(t.top,e.top,0)}}}(Annotation),function(d){"use strict";d.AnnoBoard=function(s,t){var e,n,i,a=this,o="function"==typeof Event?new Event("onAnnotationCreated"):window.event,r="function"==typeof Event?new Event("onAnnotationDeleted"):window.event,l="function"==typeof Event?new Event("onAnnotationEdited"):window.event;this.allAnnotations=[],this.pixelToNanometer=0,"string"==typeof s?(this.id=s,this.parentElem=document.getElementById(this.id)):OpenSeadragon&&s instanceof OpenSeadragon.Viewer&&(this.boardType="OpenSeadragon",this.parentElem=s.element,this.osdViewer=s,this.id=this.parentElem.getAttribute("id")),this.canvasDimensions=t,this.canvasDimensions||(this.canvasDimensions=this.parentElem.getClientRects()[0]),n=this.parentElem,i=document.createElement("canvas"),n.getAttribute("id"),i.id="canvas-overlay-"+a.id,i.style.position="absolute",i.style.top="0px",i.style.left="0px",i.style.width="100%",i.style.height="100%",i.style.zIndex="999999998",i.style.cursor="crosshair",e=i,this.parentElem.style.position="relative",this.parentElem.appendChild(e),this.overlayElem=e,this.actions=new d.actions(this.overlayElem),this.actions.attachActions(),this.hideOverlay(),this.annotations=[],this.implementedAction=null,this.showAnnotationOnOsd=function(t,e){if("OpenSeadragon"===a.boardType){if(!e){var n=new OpenSeadragon.Rect(parseFloat(t.element.style.left),parseFloat(t.element.style.top),parseFloat(t.element.style.width),parseFloat(t.element.style.height));e=s.viewport.viewerElementToViewportRectangle(n)}s.addOverlay(t.element,e)}a.allAnnotations.push(t),a.allAnnotations.sort(function(t,e){return e.size-t.size});var i=2,o=0;for(o in a.allAnnotations){a.allAnnotations[o].element.style.zIndex=i++}},this.saveAnnotation=function(t){var e=new OpenSeadragon.Rect(parseFloat(t.annotation.element.style.left),parseFloat(t.annotation.element.style.top),parseFloat(t.annotation.element.style.width),parseFloat(t.annotation.element.style.height)),n=s.viewport.viewerElementToViewportRectangle(e);a.showAnnotationOnOsd(t.annotation,n),o.annotation=t.annotation,a.parentElem.dispatchEvent(o)},a.parentElem.addEventListener("onAnnotationSave",this.saveAnnotation),this.deleteAnnotationOnOsd=function(t){for(var e in"OpenSeadragon"===a.boardType&&s.removeOverlay(t.annotation.element),a.allAnnotations)if(a.allAnnotations[e].hasOwnProperty("id")&&a.allAnnotations[e].id===t.annotation.id){a.allAnnotations.splice(e,1);break}},this.deleteAnnotation=function(t){a.deleteAnnotationOnOsd(t),r.annotation=t.annotation,a.parentElem.dispatchEvent(r)},a.parentElem.addEventListener("onAnnotationDelete",this.deleteAnnotation),this.editAnnotationOnOsd=function(t){a.boardType,l.annotation=t.annotation,a.parentElem.dispatchEvent(l)},a.parentElem.addEventListener("onAnnotationEdit",this.editAnnotationOnOsd)},d.AnnoBoard.prototype.setPixelToNanometer=function(t){this.pixelToNanometer=t},d.AnnoBoard.prototype.checkHighlights=function(){var t=this.osdViewer,e=parseFloat(t.pointerElem.style.left),n=parseFloat(t.pointerElem.style.top);for(var i in this.allAnnotations){var o=this.allAnnotations[i].element,s=parseFloat(o.style.left),a=parseFloat(o.style.top),r=parseFloat(o.style.width)+s,l=parseFloat(o.style.height)+a;if(s<=e&&e<=r&&a<=n&&n<=l){var h=this.allAnnotations[i].getHighlightPosition();d.Editor("highlight",h,this.allAnnotations[i],t.element),setTimeout(function(){d.hideEditor()},2e3)}}},d.AnnoBoard.prototype.drawAnnotation=function(t,e){switch(this.showOverlay(),t){case"OpenFreeform":this.implementedAction=new d.freeformAction;break;case"Rectangular":this.implementedAction=new d.rectangularAction;break;case"Circular":this.implementedAction=new d.circularAction;break;case"Freeform":this.implementedAction=new d.closedFreeformAction;break;case"Ruler":this.implementedAction=new d.rulerAction;var n=this.osdViewer.world.getItemAt(0),i=n._scaleSpring.current.value*n.viewport._containerInnerSize.x/n.source.dimensions.x;this.implementedAction.setConverter(this.pixelToNanometer/(i*this.osdViewer.viewport.getZoom(!0)));break;case"Arrow":this.implementedAction=new d.arrowAction}this.implementedAction.marker=e,this.actions.setBehavior(this.implementedAction)},d.AnnoBoard.prototype.showAnnotation=function(t){var e;switch(t.type){case"OpenFreeform":case"Freeform":(e=new d.freeformAction(t)).showAnnotation(t.points,this.parentElem);break;case"Rectangular":(e=new d.rectangularAction(t)).showAnnotation(this.parentElem);break;case"Circular":(e=new d.circularAction(t)).showAnnotation(this.parentElem);break;case"Ruler":e=new d.rulerAction(t);var n=this.osdViewer.world.getItemAt(0),i=n._scaleSpring.current.value*n.viewport._containerInnerSize.x/n.source.dimensions.x;e.setConverter(this.pixelToNanometer/(i*this.osdViewer.viewport.getZoom(!0))),e.showAnnotation(this.parentElem);break;case"Arrow":(e=new d.arrowAction(t)).showAnnotation(this.parentElem)}this.showAnnotationOnOsd(e)},d.AnnoBoard.prototype.removeAllAnnotations=function(){for(;0<this.allAnnotations.length;){var t=this.allAnnotations.pop();t.deleteAnnotation(),this.deleteAnnotationOnOsd({annotation:t})}},d.AnnoBoard.prototype.getAnnotations=function(){return this.annotations},d.AnnoBoard.prototype.getOverlay=function(){return this.overlayElem},d.AnnoBoard.prototype.showOverlay=function(){var t=this.overlayElem.getContext("2d");t.clearRect(0,0,t.canvas.width,t.canvas.height),this.overlayElem.style.display="block"},d.AnnoBoard.prototype.hideOverlay=function(){this.overlayElem.style.display="none"},d.AnnoBoard.prototype.destroyBoard=function(){this.parentElem.removeEventListener("onAnnotationSave",this.saveAnnotation),delete this.saveAnnotation,this.parentElem.removeEventListener("onAnnotationDelete",this.deleteAnnotation),delete this.deleteAnnotationOnOsd,this.parentElem.removeEventListener("onAnnotationEdit",this.editAnnotationOnOsd),delete this.editAnnotationOnOsd,this.overlayElem.parentNode?this.overlayElem.parentNode.removeChild(this.overlayElem):delete this.overlayElem}}(Annotation);
